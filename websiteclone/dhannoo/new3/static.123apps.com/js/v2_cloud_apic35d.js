window.CloudApi=function(){var e,o={openersContainer:".cloudOpeners",saversContainer:".cloudSavers",lang_id:_.glob_val("lang_id"),attach_savers:!0,open_params:{},callbacks:{onOpenStart:null,onOpenProgress:null,onOpenComplete:null,onOpenSuccess:null,onOpenCancel:null,onOpenError:null,onSaveStart:null,onSaveProgress:null,onSaveComplete:null,onSaveSuccess:null,onSaveCancel:null,onSaveError:null},google:{client_id:_.glob_val("GOOGLE_CLIENT_ID"),project_number:_.glob_val("GOOGLE_PROJECT_NUMBER"),api_key:_.glob_val("GOOGLE_API_KEY"),scope:["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.readonly","https://www.googleapis.com/auth/drive.install"],api:{default:"https://apis.google.com/js/api.js",platform:"https://apis.google.com/js/platform.js"},views:[]},dropbox:{app_key:_.glob_val("DROPBOX_APP_KEY"),api:{default:"https://www.dropbox.com/static/api/2/dropins.js"}},onedrive:{client_id:"",api:{default:"https://js.live.net/v7.0/OneDrive.js"}}},n=!1,a={},l={};function r(e,a){o.openersContainer&&_.on(o.openersContainer+" ."+e,"click",(function(o){n=_.hasClass(o.target,"secondary"),s(e,a),o.preventDefault()}))}function t(e,o,n){_.first(o)?"google"==e?s(e,n,"platform"):_.on(o+" ."+e,"click",(function(o){s(e,n),o.preventDefault()})):_.e("No element found for "+o)}function i(e,n){if(_.l_func(),"string"!=typeof e)return _.e("container arg should contain selector string"),!1;a[e]?(_.e("savers already attached for container "+e+", you should call update_encode_result() instead"),c(n,e)):(a[e]={},n&&(n.download_url=n.download_url.replace(/^\/\//,location.protocol+"//"),a[e].encode_result=n),t("google",e,(function(){var o=_.first(e+" .google");a[e].google_innerHTML=o.innerHTML,n&&v(e)})),t("dropbox",e,(function(){var n=a[e].encode_result;if(n){var l=n.browser_filename||n.public_filename,r=n.download_url;_.run_cb(o.callbacks.onSaveStart),Dropbox.save(r,l,{success:function(){_.run_cb(o.callbacks.onSaveSuccess)},progress:function(e){_.run_cb(o.callbacks.onSaveProgress,e)},cancel:function(){_.run_cb(o.callbacks.onSaveCancel)},error:function(e){var n;n=e,_.e(n),_.run_cb(o.callbacks.onSaveError,n)}})}else _.e("No result data for container "+e)})))}function c(e,n){_.l("update_encode_result()",e),n=n||o.saversContainer,_.isObject(e)&&e.hasOwnProperty("download_url")?a[n]?(e.download_url=e.download_url.replace(/^\/\//,location.protocol+"//"),a[n].encode_result=e,v(n)):_.e("Savers should be attached before calling update_encode_result() for "+n):_.e("result should be object and contain download_url property")}function s(e,n,a){a=a||"default",_.l("load_api_proxy: "+e+"_"+a),o[e]&&o[e].api[a]?l[e+"_"+a]?n():function(e,n,a){a=a||"default",_.l("load_api: "+e+"_"+a),"dropbox"==e?_.loadJS(o[e].api[a],n,{id:"dropboxjs",data:{appKey:o.dropbox.app_key}}):"google"==e?"platform"==a?_.loadJS(o[e].api[a],n):_.loadJS(o[e].api[a],(function(){gapi.load("auth:client",{callback:function(){n()}})})):_.loadJS(o[e].api[a],n);l[e+"_"+a]=!0}(e,n,a):n()}function d(n,a){console.log("openRemote"),n.length?(a.fileId=_.hash(n),e=ServerAPI.open_remote({remote_url:n,params:a},{onStart:function(){_.run_cb(o.callbacks.onOpenStart,n,a,e)},onProgress:function(e){_.run_cb(o.callbacks.onOpenProgress,e)},onComplete:function(e){_.run_cb(o.callbacks.onOpenComplete,e),_.isObject(e)&&e.success&&_.run_cb(o.callbacks.onOpenSuccess,e)},onError:function(e){p(e.error_desc||null,e)},onAuthRequest:function(e){_.l_func(),alert("Error: URL is password protected")}})):p("Error: URL is empty")}function p(e,n){_.e(e),n&&_.e(n),_.run_cb(o.callbacks.onOpenError,e,n)}function u(e,o,n){void 0===n&&(n=!1),void 0===o&&(o=!0),o?g(e,o,n):n?(MicroModal.show("modal_gdriveopen"),_.on("#modal_gdriveopen_ok","click",(function(){MicroModal.close("modal_gdriveopen"),g(e,!1,!1)}))):g(e,o,n)}function g(e,n,a){var l={client_id:o.google.client_id,scope:o.google.scope,immediate:n};gapi.auth.authorize(l,(function(o){o.error?(_.e(o),"immediate_failed"==o.error&&u(e,!1,a)):e(o)}))}function f(e){_.l_func(),gapi.load("picker",{callback:function(){_.run_cb(o.callbacks.onSaveStart);var n="pt"==o.lang_id?"pt-PT":o.lang_id,a=new google.picker.PickerBuilder;o.google.project_number&&a.setAppId(o.google.project_number),a.setOAuthToken(e.access_token),a.addView((new google.picker.DocsView).setIncludeFolders(!0)),o.google.views.length&&o.google.views.forEach((function(e){a.addView(google.picker.ViewId[e])})),a.addView(google.picker.ViewId.RECENTLY_PICKED),o.google.api_key&&a.setDeveloperKey(o.google.api_key),a.setCallback((function(n){n.action==google.picker.Action.PICKED?gapi.load("client",(function(){m(n.docs[0].id,e)})):n.action==google.picker.Action.CANCEL&&_.run_cb(o.callbacks.onOpenCancel)})),a.setOrigin(window.location.protocol+"//"+window.location.host),a.setLocale(n),a.build().setVisible(!0)}})}function v(e){e=e||o.saversContainer;var n=a[e].encode_result,l=_.first(e+" .google");l.style.position="relative",l.style.overflow="hidden",l.innerHTML='<div id="g-savetodrive" style="transform-origin:0px 0px; transform: scale(3,1.5); opacity: 0.0001;position: absolute;" class="g-savetodrive" data-src="" data-filename="" data-sitename=""></div>'+a[e].google_innerHTML;var r=_.first(".g-savetodrive",l);if(r){if(n)if(n.browser_filename&&!/[^\u0000-\u007f]/.test(n.browser_filename))var t=n.browser_filename;else t="File ("+window.location.host+")."+n.download_url.split(".").pop();else console.error("No encode_result defined. Was update_encode_result() called?");var i={src:n.download_url,filename:t,sitename:window.location.host};gapi.savetodrive.render(r,i),setTimeout((function(){b(e)}),2e3)}else console.error("No Google Drive save div found")}function b(e){e=e||o.saversContainer;var n=_.first(e+" .google"),a=_.first(".g-savetodrive",n);setTimeout((function(){var e=n.getBoundingClientRect(),o=parseInt(_.css(n,"padding-left")),l=parseInt(_.css(n,"padding-top")),r=parseInt(_.css(a,"width")),t=parseInt(_.css(a,"height"));if(e.width&&r){var i=e.width/r,c=e.height/t;a.style.transform="scale("+i+", "+c+")",o&&(a.style.marginLeft="-"+o+"px"),l&&(a.style.marginTop="-"+l+"px")}else console.error("gdriveWidth or providerRect.width not obtained")}),300)}function m(e,a,l){l=l||!1,gapi.client.load("drive","v2",(function(){gapi.client.drive.files.get({fileId:e}).execute((function(r){r.downloadUrl?d(r.downloadUrl,{google_access_token:a.access_token,original_filename:r.originalFilename,file_extension:r.fileExtension,filesize:r.fileSize,secondary:n,open_params:o.open_params}):"401"==r.code?u((function(o){m(e,o)}),!1,l):p("request error",r)}))}))}return{init:function(e){console.log("CloudApi init",e),o=_.deepMerge(o,e),r("google",(function(){try{u(f)}catch(e){console.log(e.message)}})),r("dropbox",(function(){Dropbox.choose({success:function(e){d(e[0].link,{original_filename:e[0].name,filesize:e[0].bytes,secondary:n,open_params:o.open_params})},cancel:function(){_.run_cb(o.callbacks.onOpenCancel)},multiselect:!1,linkType:"direct"})})),o.attach_savers&&i(o.saversContainer),r("url",(function(){var e=prompt("Enter link here:");e?d(e,{secondary:n,open_params:o.open_params}):_.run_cb(o.callbacks.onOpenCancel)})),function(){var e=new URLSearchParams(window.location.search);if(e.has("state")){var o=JSON.parse(e.get("state"));if("open"==o.action){var n=o.ids[0];s("google",(function(){u((function(e){m(n,e,!0)}),!0,!0)}))}}}()},cancel:function(o){_.l_func(),(o=o||e||null)?ServerAPI.cancel(o):_.e("no operation_id")},rescale_hidden_google_saver:b,update_encode_result:c,attach_savers:i}}();